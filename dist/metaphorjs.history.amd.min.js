define("metaphorjs-history",["metaphorjs-observable"],function(E){var s=function(a,b,c){a.attachEvent?a.attachEvent("on"+b,c):a.addEventListener(b,c,!1)},p=function(){return!1},m=function(){return!0},t=function(a){if(a instanceof t)return a;if(!(this instanceof t))return new t(a);for(var b in a)if(!this[b])try{this[b]=a[b]}catch(c){}this.originalEvent=a;this.type=a.type;!this.target&&a.srcElement&&(this.target=a.srcElement);var d,f=a.button;void 0===this.pageX&&null!==a.clientX&&(d=this.target?this.target.ownerDocument||
document:document,b=d.documentElement,d=d.body,this.pageX=a.clientX+(b&&b.scrollLeft||d&&d.scrollLeft||0)-(b&&b.clientLeft||d&&d.clientLeft||0),this.pageY=a.clientY+(b&&b.scrollTop||d&&d.scrollTop||0)-(b&&b.clientTop||d&&d.clientTop||0));this.which||void 0===f||(this.which=f&1?1:f&2?3:f&4?2:0);this.isDefaultPrevented=a.defaultPrevented||void 0===a.defaultPrevented&&!1===a.returnValue?m:p;this.timeStamp=a&&a.timeStamp||(new Date).getTime()};t.prototype={isDefaultPrevented:p,isPropagationStopped:p,
isImmediatePropagationStopped:p,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=m;a.returnValue=!1;a&&a.preventDefault&&a.preventDefault()},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=m;a&&a.stopPropagation&&a.stopPropagation()},stopImmediatePropagation:function(){var a=this.originalEvent;this.isImmediatePropagationStopped=m;a&&a.stopImmediatePropagation&&a.stopImmediatePropagation();this.stopPropagation()}};var F=Array.prototype.slice,
G=Object.prototype.toString,H=function(){var a={"[object String]":0,"[object Number]":1,"[object Boolean]":2,"[object Object]":3,"[object Function]":4,"[object Array]":5,"[object RegExp]":9,"[object Date]":10};return function(b){if(!b){if(null===b)return 6;if(void 0===b)return 7}var c=a[G.call(b)];return void 0===c?-1:1==c&&isNaN(b)?8:c}}(),n=function(a){return"object"==typeof a&&3===H(a)&&!a.nodeType},u=function(a){return!0===a||!1===a},I=function(){return function b(){var c=!1,d=!1,f=F.call(arguments),
g=f.shift(),k,h,l;u(f[f.length-1])&&(c=f.pop());u(f[f.length-1])&&(d=c,c=f.pop());for(;f.length;)if(k=f.shift())for(h in k)if(k.hasOwnProperty(h)&&void 0!==(l=k[h]))if(d)if(g[h]&&n(g[h])&&n(l))b(g[h],l,c,d);else{if(!0===c||void 0==g[h])n(l)?(g[h]={},b(g[h],l,c,!0)):g[h]=l}else if(!0===c||void 0==g[h])g[h]=l;return g}}(),y=function(){},z=function(){var a={};return function(b){return a[b]||(a[b]=new RegExp(b))}}(),A=function(a,b,c,d){setTimeout(function(){a.apply(b,c||[])},d||0)};return function(){var a=
window,b=a.history,c=a.location,d=new E,f={},g={},k={locationChange:[],beforeLocationChange:[]},h=!1,l=/(?:(\w+:))?(?:\/\/(?:[^@]*@)?([^\/:\?#]+)(?::([0-9]+))?)?([^\?#]*)(?:(\?[^#]+)|\?)?(?:(#.*))?/,v=!!b.pushState,p="onhashchange"in a,m=v&&(navigator.vendor||"").match(/Opera/);I(f,d.getApi());var q=function(e){var a=c.protocol+"//"+c.hostname;c.port&&(a+=":"+c.port);e=e.replace(a,"");v||(e=encodeURIComponent(e));"?"==e.substr(0,1)&&(e=c.pathname+e);m&&(e=e.replace("?","#"));return e},n=function(e){e=
(""+e).match(l);var a,b;if(!v||m)b=e[6],"!"==b.substr(0,1)&&(a=b.substr(1));a||(a=e[4],e[5]&&(a+=e[5]));return a},u=function(a){c.hash=a?"!"+a:""},x=function(){var a;v?a=c.pathname+c.search+c.hash:(a=c.hash.substr(1))?("!"==a.substr(0,1)&&(a=a.substr(1)),a=decodeURIComponent(a)):a=c.pathname+c.search;return a},B=function(a,b){var c=g[a].extractor;return"function"==typeof c?c(b,a):(c=b.match(c))?c.pop():null},w=function(){var a=x();r("locationChange",!1,a);var b,c,d;for(b in g)c=g[b].value,d=B(b,a),
g[b].value=d,d!=c&&f.trigger("change-"+b,d,c,b,a)},r=function(a,b,c){c=c||x();for(var d,C=-1,J=k[a].length;++C<J;)if(d=k[a][C].call(null,c),b&&!1===d)return!1;return f.trigger(a,c)},D=function(){if(v)b.origPushState=b.pushState,b.origReplaceState=b.replaceState,s(a,"popstate",w),b.pushState=function(a,c,e){if(!1===r("beforeLocationChange",!0,e))return!1;b.origPushState(a,c,q(e));w()},b.replaceState=function(a,c,e){if(!1===r("beforeLocationChange",!0,e))return!1;b.origReplaceState(a,c,q(e));w()};else if(p)b.replaceState=
b.pushState=function(a,b,c){if(!1===r("beforeLocationChange",!0,c))return!1;A(u,null,[q(c)])},s(a,"hashchange",w);else{var e=null,d=!1;a.onIframeHistoryChange=function(a){d||A(function(){u(a);w()})};var g=function(a){var b=e.contentWindow.document;b.open();b.write("<html><head><title>"+document.title+'</title><script type="text/javascript">var hashValue = "'+a+'";window.top.onIframeHistoryChange(hashValue);\x3c/script></head><body>&nbsp;</body></html>');b.close()};b.pushState=function(a,b,c){if(!1===
r("beforeLocationChange",!0,c))return!1;g(q(c))};b.replaceState=function(a,b,c){if(!1===r("beforeLocationChange",!0,c))return!1;a=q(c);e.contentWindow.hashValue=a};var k=function(){e=document.createElement("iframe");e.src="about:blank";e.style.display="none";document.body.appendChild(e);d=!0;g(q(c.hash.substr(1)));d=!1};h?k():s(a,"load",k)}s(document.documentElement,"click",function(e){e=new t(e||a.event);for(var d=e.target,f;d&&"a"!=d.nodeName.toLowerCase();)d=d.parentNode;if(d){if(d=(f=d.getAttribute("href"))&&
"#"!=f.substr(0,1)&&!d.getAttribute("target"))d=f.match(l),d=d[1]&&c.protocol!=d[1]||d[2]&&c.hostname!=d[2]?!1:d[2]||d[3]?c.port==d[3]:!0;if(d&&n(f)!=n(c))return b.pushState(null,null,n(f)),e.preventDefault(),e.stopPropagation(),!1}return null});b.initPushState=y;f.initPushState=y};s(a,"load",function(){h=!0});b.initPushState=D;b.onBeforeChange=function(a){k.beforeLocationChange.push(a)};b.onChange=function(a){k.locationChange.push(a)};f.pushUrl=function(a){b.pushState(null,null,a)};f.replaceUrl=
function(a){b.replaceState(null,null,a)};f.currentUrl=function(){return x()};f.initPushState=function(){return D()};f.getParam=function(a){return g[a]?g[a].value:null};f.addParam=function(a,b){g[a]||(b?"function"!=typeof b&&(b="string"==typeof b||b===""+b?z(b):b):b=z(a+"=([^&]+)"),g[a]={name:a,value:null,extractor:b},g[a].value=B(a,x()))};return f}()});
