define("metaphorjs-history",["metaphorjs-observable"],function(x){var s=function(a,b,c){a.attachEvent?a.attachEvent("on"+b,c):a.addEventListener(b,c,!1)},q=function(){return!1},m=function(){return!0},t=function(a){if(a instanceof t)return a;if(!(this instanceof t))return new t(a);for(var b in a)if(!this[b])try{this[b]=a[b]}catch(c){}this.originalEvent=a;this.type=a.type;!this.target&&a.srcElement&&(this.target=a.srcElement);var d,e=a.button;void 0===this.pageX&&null!==a.clientX&&(d=this.target?this.target.ownerDocument||
document:document,b=d.documentElement,d=d.body,this.pageX=a.clientX+(b&&b.scrollLeft||d&&d.scrollLeft||0)-(b&&b.clientLeft||d&&d.clientLeft||0),this.pageY=a.clientY+(b&&b.scrollTop||d&&d.scrollTop||0)-(b&&b.clientTop||d&&d.clientTop||0));this.which||void 0===e||(this.which=e&1?1:e&2?3:e&4?2:0);this.isDefaultPrevented=a.defaultPrevented||void 0===a.defaultPrevented&&!1===a.returnValue?m:q;this.timeStamp=a&&a.timeStamp||(new Date).getTime()};t.prototype={isDefaultPrevented:q,isPropagationStopped:q,
isImmediatePropagationStopped:q,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=m;a.returnValue=!1;a&&a.preventDefault&&a.preventDefault()},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=m;a&&a.stopPropagation&&a.stopPropagation()},stopImmediatePropagation:function(){var a=this.originalEvent;this.isImmediatePropagationStopped=m;a&&a.stopImmediatePropagation&&a.stopImmediatePropagation();this.stopPropagation()}};var y=Array.prototype.slice,
z=Object.prototype.toString,A=function(){var a={"[object String]":0,"[object Number]":1,"[object Boolean]":2,"[object Object]":3,"[object Function]":4,"[object Array]":5,"[object RegExp]":9,"[object Date]":10};return function(b){if(!b){if(null===b)return 6;if(void 0===b)return 7}var c=a[z.call(b)];return void 0===c?-1:1==c&&isNaN(b)?8:c}}(),l=function(a){return"object"==typeof a&&3===A(a)&&!a.nodeType},n=function(a){return!0===a||!1===a},B=function(){return function b(){var c=!1,d=!1,e=y.call(arguments),
f=e.shift(),p,g,h;n(e[e.length-1])&&(c=e.pop());n(e[e.length-1])&&(d=c,c=e.pop());for(;e.length;)if(p=e.shift())for(g in p)if(p.hasOwnProperty(g)&&void 0!==(h=p[g]))if(d)if(f[g]&&l(f[g])&&l(h))b(f[g],h,c,d);else{if(!0===c||void 0==f[g])l(h)?(f[g]={},b(f[g],h,c,!0)):f[g]=h}else if(!0===c||void 0==f[g])f[g]=h;return f}}(),u=function(){},v=function(a,b,c){return a&&a.getAttribute?void 0===c?a.getAttribute(b):null===c?a.removeAttribute(b):a.setAttribute(b,c):null};return function(){var a=window,b=a.history,
c=a.location,d=new x,e={},f={locationChange:[],beforeLocationChange:[]},p=!1,g=/(?:(\w+:))?(?:\/\/(?:[^@]*@)?([^\/:\?#]+)(?::([0-9]+))?)?([^\?#]*)(?:(\?[^#]+)|\?)?(?:(#.*))?/,h=!!b.pushState,q="onhashchange"in a;B(e,d.getApi());var r=function(a){var b=c.protocol+"//"+c.hostname;c.port&&(b+=":"+c.port);a=a.replace(b,"");h||(a=encodeURIComponent(a));return a},m=function(a){a=(""+a).match(g);var b,c;h||(c=a[6],"!"==c.substr(0,1)&&(b=c.substr(1)));b||(b=a[4],a[5]&&(b+="?"+a[5]));return b},l=function(){var a;
h?a=c.pathname+c.search:(a=c.hash.substr(1))?("!"==a.substr(0,1)&&(a=a.substr(1)),a=decodeURIComponent(a)):a=c.pathname+c.search;return a},k=function(a,b,c){c=c||l();for(var d,w=-1,C=f[a].length;++w<C;)if(d=f[a][w].call(null,c),b&&!1===d)return!1;return e.trigger(a,c)},n=function(){if(h)b.origPushState=b.pushState,b.origReplaceState=b.replaceState,s(a,"popstate",function(){k("locationChange")}),b.pushState=function(a,c,d){if(!1===k("beforeLocationChange",!0,d))return!1;b.origPushState(a,c,r(d));k("locationChange")},
b.replaceState=function(a,c,d){if(!1===k("beforeLocationChange",!0,d))return!1;b.origReplaceState(a,c,r(d));k("locationChange")};else if(q)b.replaceState=b.pushState=function(a,b,d){if(!1===k("beforeLocationChange",!0,d))return!1;a=r(d);c.hash=a?"!"+a:""},s(a,"hashchange",function(){k("locationChange")});else{var d=null,f=!1;a.onIframeHistoryChange=function(a){f||(c.hash=a?"!"+a:"",k("locationChange"))};var l=function(a){var b=d.contentWindow.document;b.open();b.write("<html><head><title>"+document.title+
'</title><script type="text/javascript">var hashValue = "'+a+'";window.top.onIframeHistoryChange(hashValue);\x3c/script></head><body>&nbsp;</body></html>');b.close()};b.pushState=function(a,b,c){if(!1===k("beforeLocationChange",!0,c))return!1;l(r(c))};b.replaceState=function(a,b,c){if(!1===k("beforeLocationChange",!0,c))return!1;a=r(c);d.contentWindow.hashValue=a};var n=function(){d=document.createElement("iframe");d.src="about:blank";d.style.display="none";document.body.appendChild(d);f=!0;l(r(c.hash.substr(1)));
f=!1};p?n():s(a,"load",n)}s(document.documentElement,"click",function(d){d=new t(d||a.event);for(var e=d.target,f;e&&"a"!=e.nodeName.toLowerCase();)e=e.parentNode;if(e){if(e=(f=v(e,"href"))&&"#"!=f.substr(0,1)&&!v(e,"target"))e=f.match(g),e=e[1]&&c.protocol!=e[1]||e[2]&&c.hostname!=e[2]?!1:e[2]||e[3]?c.port==e[3]:!0;if(e&&m(f)!=m(c))return b.pushState(null,null,m(f)),d.preventDefault(),d.stopPropagation(),!1}return null});b.initPushState=u;e.initPushState=u};s(a,"load",function(){p=!0});b.initPushState=
n;b.onBeforeChange=function(a){f.beforeLocationChange.push(a)};b.onChange=function(a){f.locationChange.push(a)};e.pushUrl=function(a){b.pushState(null,null,a)};e.replaceUrl=function(a){b.replaceState(null,null,a)};e.currentUrl=function(){return l()};e.initPushState=function(){return n()};return e}()});
