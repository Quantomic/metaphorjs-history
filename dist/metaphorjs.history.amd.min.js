define("metaphorjs-history",["metaphorjs-observable"],function(y){var t=function(d,c,a){d.attachEvent?d.attachEvent("on"+c,a):d.addEventListener(c,a,!1)},r=function(){return!1},q=function(){return!0},l=function(d){return"undefined"==typeof d},u=function(d){if(d instanceof u)return d;if(!(this instanceof u))return new u(d);for(var c in d)if(!this[c])try{this[c]=d[c]}catch(a){}this.originalEvent=d;this.type=d.type;!this.target&&d.srcElement&&(this.target=d.srcElement);var b,g=d.button;l(this.pageX)&&
null!==d.clientX&&(b=this.target?this.target.ownerDocument||document:document,c=b.documentElement,b=b.body,this.pageX=d.clientX+(c&&c.scrollLeft||b&&b.scrollLeft||0)-(c&&c.clientLeft||b&&b.clientLeft||0),this.pageY=d.clientY+(c&&c.scrollTop||b&&b.scrollTop||0)-(c&&c.clientTop||b&&b.clientTop||0));this.which||void 0===g||(this.which=g&1?1:g&2?3:g&4?2:0);this.isDefaultPrevented=d.defaultPrevented||l(d.defaultPrevented)&&!1===d.returnValue?q:r;this.timeStamp=d&&d.timeStamp||(new Date).getTime()};u.prototype=
{isDefaultPrevented:r,isPropagationStopped:r,isImmediatePropagationStopped:r,preventDefault:function(){var d=this.originalEvent;this.isDefaultPrevented=q;d.returnValue=!1;d&&d.preventDefault&&d.preventDefault()},stopPropagation:function(){var d=this.originalEvent;this.isPropagationStopped=q;d&&d.stopPropagation&&d.stopPropagation()},stopImmediatePropagation:function(){var d=this.originalEvent;this.isImmediatePropagationStopped=q;d&&d.stopImmediatePropagation&&d.stopImmediatePropagation();this.stopPropagation()}};
var z=Array.prototype.slice,p=function(d){return!(!d||d.constructor!==Object)},A=function c(){var a=!1,b=!1,g=z.call(arguments),e=g.shift(),k,h,m;"boolean"==typeof g[g.length-1]&&(a=g.pop());"boolean"==typeof g[g.length-1]&&(b=a,a=g.pop());for(;g.length;)if(k=g.shift())for(h in k)if(k.hasOwnProperty(h)&&!l(m=k[h]))if(b)if(e[h]&&p(e[h])&&p(m))c(e[h],m,a,b);else{if(!0===a||l(e[h])||null===e[h])p(m)?(e[h]={},c(e[h],m,a,!0)):e[h]=m}else if(!0===a||l(e[h])||null===e[h])e[h]=m;return e},v=function(){};
return function(){var c=window,a=c.history,b=c.location,g=new y,e={},k={locationChange:[],beforeLocationChange:[]},h=!1,m=/(?:(\w+:))?(?:\/\/(?:[^@]*@)?([^\/:\?#]+)(?::([0-9]+))?)?([^\?#]*)(?:(\?[^#]+)|\?)?(?:(#.*))?/,l=!!a.pushState,r="onhashchange"in c;A(e,g.getApi());var s=function(f){var a=b.protocol+"//"+b.hostname;b.port&&(a+=":"+b.port);f=f.replace(a,"");l||(f=encodeURIComponent(f));return f},q=function(f){f=(""+f).match(m);var a,b;l||(b=f[6],"!"==b.substr(0,1)&&(a=b.substr(1)));a||(a=f[4],
f[5]&&(a+="?"+f[5]));return a},p=function(){var a;l?a=b.pathname+b.search:(a=b.hash.substr(1))?("!"==a.substr(0,1)&&(a=a.substr(1)),a=decodeURIComponent(a)):a=b.pathname+b.search;return a},n=function(a,b,c){c=c||p();for(var h,w=-1,B=k[a].length;++w<B;)if(h=k[a][w].call(null,c),b&&!1===h)return!1;return e.trigger(a,c)},x=function(){if(l)a.origPushState=a.pushState,a.origReplaceState=a.replaceState,t(c,"popstate",function(){n("locationChange")}),a.pushState=function(b,c,f){if(!1===n("beforeLocationChange",
!0,f))return!1;a.origPushState(b,c,s(f));n("locationChange")},a.replaceState=function(b,c,f){if(!1===n("beforeLocationChange",!0,f))return!1;a.origReplaceState(b,c,s(f));n("locationChange")};else if(r)a.replaceState=a.pushState=function(a,c,f){if(!1===n("beforeLocationChange",!0,f))return!1;a=s(f);b.hash=a?"!"+a:""},t(c,"hashchange",function(){n("locationChange")});else{var f=null,g=!1;c.onIframeHistoryChange=function(a){g||(b.hash=a?"!"+a:"",n("locationChange"))};var k=function(a){var b=f.contentWindow.document;
b.open();b.write("<html><head><title>"+document.title+'</title><script type="text/javascript">var hashValue = "'+a+'";window.top.onIframeHistoryChange(hashValue);\x3c/script></head><body>&nbsp;</body></html>');b.close()};a.pushState=function(a,b,c){if(!1===n("beforeLocationChange",!0,c))return!1;k(s(c))};a.replaceState=function(a,b,c){if(!1===n("beforeLocationChange",!0,c))return!1;a=s(c);f.contentWindow.hashValue=a};var p=function(){f=document.createElement("iframe");f.src="about:blank";f.style.display=
"none";document.body.appendChild(f);g=!0;k(s(b.hash.substr(1)));g=!1};h?p():t(c,"load",p)}t(document.documentElement,"click",function(f){f=new u(f||c.event);for(var e=f.target,g;e&&"a"!=e.nodeName.toLowerCase();)e=e.parentNode;if(e){if(e=(g=e.getAttribute("href"))&&"#"!=g.substr(0,1)&&!e.getAttribute("target"))e=g.match(m),e=e[1]&&b.protocol!=e[1]||e[2]&&b.hostname!=e[2]?!1:e[2]||e[3]?b.port==e[3]:!0;if(e&&q(g)!=q(b))return a.pushState(null,null,q(g)),f.preventDefault(),f.stopPropagation(),!1}return null});
a.initPushState=v;e.initPushState=v};t(c,"load",function(){h=!0});a.initPushState=x;a.onBeforeChange=function(a){k.beforeLocationChange.push(a)};a.onChange=function(a){k.locationChange.push(a)};e.pushUrl=function(b){a.pushState(null,null,b)};e.replaceUrl=function(b){a.replaceState(null,null,b)};e.currentUrl=function(){return p()};e.initPushState=function(){return x()};return e}()});
