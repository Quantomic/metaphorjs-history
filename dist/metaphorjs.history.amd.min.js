'use strict';define("metaphorjs-history",["metaphorjs-observable"],function(D){function v(a,b,c){a.attachEvent?a.attachEvent("on"+b,c):a.addEventListener(b,c,!1)}function n(){return!1}function m(){return!0}function p(a){return"object"==typeof a&&3===E(a)&&!a.nodeType&&a.constructor===Object}function w(a){return!0===a||!1===a}function F(){}function z(a,b,c,e){setTimeout(function(){a.apply(b,c||[])},e||0)}var G=Array.prototype.slice,H=Object.prototype.toString,E=function(){var a={"[object String]":0,
"[object Number]":1,"[object Boolean]":2,"[object Object]":3,"[object Function]":4,"[object Array]":5,"[object RegExp]":9,"[object Date]":10};return function(b){if(!b){if(null===b)return 6;if(void 0===b)return 7}var c=a[H.call(b)];return void 0===c?-1:1==c&&isNaN(b)?8:c}}(),A=function(){return function b(){var c=!1,e=!1,d=G.call(arguments),g=d.shift(),l,h,k;w(d[d.length-1])&&(c=d.pop());w(d[d.length-1])&&(e=c,c=d.pop());for(;d.length;)if(l=d.shift())for(h in l)if(l.hasOwnProperty(h)&&void 0!==(k=
l[h]))if(e)if(g[h]&&p(g[h])&&p(k))b(g[h],k,c,e);else{if(!0===c||void 0==g[h])p(k)?(g[h]={},b(g[h],k,c,!0)):g[h]=k}else if(!0===c||void 0==g[h])g[h]=k;return g}}(),x=function(a){if(a instanceof x)return a;if(!(this instanceof x))return new x(a);for(var b in a)if(!this[b])try{this[b]=a[b]}catch(c){}this.originalEvent=a;this.type=a.type;!this.target&&a.srcElement&&(this.target=a.srcElement);var e,d=a.button;void 0===this.pageX&&null!==a.clientX&&(e=this.target?this.target.ownerDocument||window.document:
window.document,b=e.documentElement,e=e.body,this.pageX=a.clientX+(b&&b.scrollLeft||e&&e.scrollLeft||0)-(b&&b.clientLeft||e&&e.clientLeft||0),this.pageY=a.clientY+(b&&b.scrollTop||e&&e.scrollTop||0)-(b&&b.clientTop||e&&e.clientTop||0));this.which||void 0===d||(this.which=d&1?1:d&2?3:d&4?2:0);this.isDefaultPrevented=a.defaultPrevented||void 0===a.defaultPrevented&&!1===a.returnValue?m:n;this.timeStamp=a&&a.timeStamp||(new Date).getTime()};A(x.prototype,{isDefaultPrevented:n,isPropagationStopped:n,
isImmediatePropagationStopped:n,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=m;a.returnValue=!1;a&&a.preventDefault&&a.preventDefault()},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=m;a&&a.stopPropagation&&a.stopPropagation()},stopImmediatePropagation:function(){var a=this.originalEvent;this.isImmediatePropagationStopped=m;a&&a.stopImmediatePropagation&&a.stopImmediatePropagation();this.stopPropagation()}},!0,!1);var B=function(){var a=
{};return function(b){return a[b]||(a[b]=new RegExp(b))}}();return function(){var a,b,c,e=new D,d={},g,l,h="undefined"==typeof window,k=/(?:(\w+:))?(?:\/\/(?:[^@]*@)?([^\/:\?#]+)(?::([0-9]+))?)?([^\?#]*)(?:(\?[^#]+)|\?)?(?:(#.*))?/,s,n,m;e.createEvent("beforeLocationChange",!1);var t=function(f){var a=c.protocol+"//"+c.hostname;c.port&&(a+=":"+c.port);f=f.replace(a,"");s||(f=encodeURIComponent(f));"?"==f.substr(0,1)&&(f=c.pathname+f);m&&(f=f.replace("?","#"));return f},p=function(a){a=(""+a).match(k);
var b,c;if(!s||m)c=a[6],"!"==c.substr(0,1)&&(b=c.substr(1));b||(b=a[4],a[5]&&(b+=a[5]));return b},w=function(a){c.hash=a?"!"+a:""},q=function(){var a;s?a=c.pathname+c.search+c.hash:(a=c.hash.substr(1))?("!"==a.substr(0,1)&&(a=a.substr(1)),a=decodeURIComponent(a)):a=c.pathname+c.search;return a},C=function(a,b){var c=d[a].extractor;return"function"==typeof c?c(b,a):(c=b.match(c))?c.pop():null},y=function(){var a=q();u("locationChange",a);var b,c,g;for(b in d)c=d[b].value,g=C(b,a),d[b].value=g,g!=c&&
e.trigger("change-"+b,g,c,b,a)},u=function(a,b){var c=b||q();return e.trigger(a,c)},r=function(){a=window;b=a.history;c=a.location;s=!!b.pushState;n="onhashchange"in a;m=s&&(navigator.vendor||"").match(/Opera/);if(s)b.origPushState=b.pushState,b.origReplaceState=b.replaceState,v(a,"popstate",y),g=function(a){if(!1===u("beforeLocationChange",a))return!1;b.origPushState(null,null,t(a));y()},l=function(a){if(!1===u("beforeLocationChange",a))return!1;b.origReplaceState(null,null,t(a));y()};else if(n)l=
g=function(a){if(!1===u("beforeLocationChange",a))return!1;z(w,null,[t(a)])},v(a,"hashchange",y);else{var f=null,d=!1;a.onIframeHistoryChange=function(a){d||z(function(){w(a);y()})};var e=function(a){var b=f.contentWindow.document;b.open();b.write("<html><head><title>"+document.title+'</title><script type="text/javascript">var hashValue = "'+a+'";window.top.onIframeHistoryChange(hashValue);\x3c/script></head><body>&nbsp;</body></html>');b.close()};g=function(a){if(!1===u("beforeLocationChange",a))return!1;
e(t(a))};l=function(a){if(!1===u("beforeLocationChange",a))return!1;a=t(a);f.contentWindow.hashValue=a};var q=function(){f=window.document.createElement("iframe");f.src="about:blank";f.style.display="none";window.document.body.appendChild(f);d=!0;e(t(c.hash.substr(1)));d=!1};h?q():v(a,"load",q)}v(window.document.documentElement,"click",function(f){f=new x(f||a.event);for(var d=f.target,e;d&&"a"!=d.nodeName.toLowerCase();)d=d.parentNode;if(d){if(d=(e=d.getAttribute?d.getAttribute("href"):null)&&"#"!=
e.substr(0,1)&&(!d.getAttribute||!d.getAttribute("target")))d=e.match(k),d=d[1]&&c.protocol!=d[1]||d[2]&&c.hostname!=d[2]?!1:d[2]||d[3]?c.port==d[3]:!0;if(d&&p(e)!=p(c))return b.pushState(null,null,p(e)),f.preventDefault(),f.stopPropagation(),!1}return null});r=F};v(window,"load",function(){h=!0});return A({},e.getApi(),{push:function(a){r();b.pushState(null,null,a)},replace:function(a){r();b.replaceState(null,null,a)},current:function(){r();return q()},init:function(){return r()},polyfill:function(){r();
window.history.pushState=function(a,b,c){g(c)};window.history.replaceState=function(a,b,c){l(c)}},getParam:function(a){return d[a]?d[a].value:null},addParam:function(a,b){r();d[a]||(b?"function"!=typeof b&&(b="string"==typeof b||b===""+b?B(b):b):b=B(a+"=([^&]+)"),d[a]={name:a,value:null,extractor:b},d[a].value=C(a,q()))}})}()});
